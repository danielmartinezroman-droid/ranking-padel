<script>
  // CSV publicado de Google Sheets (RANKING)
  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR4k0Xp5Md7dP_B21PdKHsi_7V0MuaDZpbVWsErYtAaGKpdbnqTiuFOnGlhwHbc5QHsRF4vwcZjY66e/pub?gid=970064869&single=true&output=csv";

  // Mapa nombre -> foto local en tu repo
  const AVATARS = {
    "Dani M.": "img/dani-m.jpg",
    "Yuri": "img/yuri.jpg",
    "Feli": "img/feli.jpg",
    "Dani A.": "img/dani-a.jpg",
    "Ric": "img/ric.jpg",
    "Esteban": "img/esteban.jpg"
  };

  const perf = p => (Number(p.sets) > 0 ? Math.round((Number(p.won) / Number(p.sets)) * 100) : 0);
  const badgeClass = pct => pct >= 67 ? "good" : pct >= 34 ? "warn" : "bad";

  function medalLabel(pct){
    if (pct >= 67) return { text: "Elite", cls: "elite" };
    if (pct >= 34) return { text: "En pelea", cls: "fight" };
    return { text: "Remontar", cls: "comeback" };
  }

  function renderPodium(sorted){
    const podium = document.getElementById("podium");
    if (!podium) return;

    const top3 = sorted.slice(0,3);
    const order = [1,0,2]; // #2 izq, #1 centro, #3 der
    const mapped = order.map(i => top3[i]).filter(Boolean);

    podium.innerHTML = mapped.map(p => {
      const pct = perf(p);
      const m = medalLabel(pct);

      const realRank = (p === top3[0]) ? 1 : (p === top3[1]) ? 2 : 3;
      const big = realRank === 1 ? "podiumBig" : "";
      const medalClass = realRank === 1 ? "medalGold" : realRank === 2 ? "medalSilver" : "medalBronze";
      const rankClass = realRank === 1 ? "rank1" : realRank === 2 ? "rank2" : "rank3";

      return `
        <div class="podiumCard ${big} ${rankClass}" data-rank="${realRank}">
          <div class="podiumTop">
            <div class="podiumAvatar">
              <img src="${p.avatar}" alt="Foto de ${p.name}" onerror="this.style.display='none'">
            </div>
            <span class="podiumMedal ${medalClass}">${realRank}</span>
          </div>

          <div class="podiumName">
            <strong>${p.name}</strong>
            <div class="podiumMeta">
              <span class="badge ${badgeClass(pct)}">${pct}%</span>
              <span class="badge ${m.cls}">${m.text}</span>
              <span style="font-family: var(--mono); opacity:.75;">${p.won}G · ${p.lost}P · ${p.sets} sets</span>
            </div>
            <div class="bar" aria-label="Rendimiento ${pct}%">
              <span style="--w:${pct}%"></span>
            </div>
          </div>
        </div>
      `;
    }).join("");
  }

  // CSV parser simple (soporta comillas)
  function parseCSV(text){
    const rows = [];
    let row = [];
    let cell = "";
    let inQuotes = false;

    for (let i = 0; i < text.length; i++){
      const c = text[i];
      const next = text[i+1];

      if (c === '"' && inQuotes && next === '"'){ cell += '"'; i++; continue; }
      if (c === '"'){ inQuotes = !inQuotes; continue; }

      if (c === ',' && !inQuotes){ row.push(cell); cell=""; continue; }
      if ((c === '\n' || c === '\r') && !inQuotes){
        if (c === '\r' && next === '\n') i++;
        row.push(cell); cell="";
        // evita líneas vacías
        if (row.some(v => String(v).trim() !== "")) rows.push(row);
        row = [];
        continue;
      }
      cell += c;
    }
    row.push(cell);
    if (row.some(v => String(v).trim() !== "")) rows.push(row);
    return rows;
  }

  async function loadPlayersFromSheet(){
    const res = await fetch(CSV_URL, { cache: "no-store" });
    if (!res.ok) throw new Error("No pude leer CSV (HTTP " + res.status + ")");
    const csv = await res.text();

    const rows = parseCSV(csv);
    const headers = rows.shift().map(h => String(h).trim());

    const idx = (name) => headers.findIndex(h => h.toLowerCase() === name.toLowerCase());

    const iName = idx("name");
    const iSets = idx("sets");
    const iWon  = idx("won");
    const iLost = idx("lost");
    const iAvatar = idx("avatar"); // opcional

    const players = rows.map(r => {
      const name = String(r[iName] ?? "").trim();
      const avatarFromSheet = iAvatar >= 0 ? String(r[iAvatar] ?? "").trim() : "";
      return {
        name,
        sets: Number(r[iSets] ?? 0),
        won:  Number(r[iWon] ?? 0),
        lost: Number(r[iLost] ?? 0),
        avatar: avatarFromSheet || AVATARS[name] || ""
      };
    }).filter(p => p.name);

    return players;
  }

  function render(players){
    const sorted = [...players].sort((a,b) =>
      perf(b) - perf(a) ||
      Number(b.sets || 0) - Number(a.sets || 0) ||
      String(a.name || "").localeCompare(String(b.name || ""))
    );

    document.getElementById("totalSets").textContent =
      players.reduce((s,p)=>s+Number(p.sets||0),0);

    document.getElementById("totalWins").textContent =
      players.reduce((s,p)=>s+Number(p.won||0),0);

    renderPodium(sorted);

    const list = document.getElementById("list");
    list.innerHTML = "";

    sorted.forEach((p, idx) => {
      const pct = perf(p);
      const m = medalLabel(pct);

      const card = document.createElement("div");
      card.className = "card " + m.cls;
      card.style.animationDelay = (idx * 70) + "ms";

      card.innerHTML = `
        <div class="left">
          <div class="rank">#${idx+1}</div>
          <div class="avatar">
            <img src="${p.avatar}" alt="Foto de ${p.name}" onerror="this.style.display='none'">
          </div>
          <div class="nameBlock">
            <div class="nameLine">
              <strong>${p.name}</strong>
              <span class="badge ${badgeClass(pct)}">${pct}%</span>
              <span class="badge ${m.cls}">${m.text}</span>
              <span style="color: rgba(255,255,255,.55); font-size:12px; font-family: var(--mono);">
                ${p.won}G · ${p.lost}P
              </span>
            </div>
            <div class="bar" aria-label="Rendimiento ${pct}%">
              <span style="--w:${pct}%"></span>
            </div>
          </div>
        </div>

        <div class="right">
          <div class="pill">Sets: <b>${p.sets}</b></div>
          <div class="pill">Ganados: <b>${p.won}</b></div>
          <div class="pill">Perdidos: <b>${p.lost}</b></div>
        </div>
      `;

      list.appendChild(card);
    });
  }

  async function main(){
    try{
      const players = await loadPlayersFromSheet();
      render(players);
    }catch(e){
      console.error(e);
      const list = document.getElementById("list");
      list.innerHTML = `<div class="card" style="opacity:1; animation:none;">
        <div style="color: rgba(255,255,255,.85);">Error cargando Google Sheets. Revisa consola (F12).</div>
      </div>`;
    }
  }

  main();
  setInterval(main, 60000);
</script>
